<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:b="http://bootsfaces.net/ui"
      xmlns:my="http://java.sun.com/jsf/composite/recursos"
      xmlns:p="http://primefaces.org/ui"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets">
    
    <f:event listener="#{LoginBean.comprobarLogin}" type="preRenderView" />

    <h:head>
        <title>Departamento Médico</title>
        <link rel="shortcut icon" type="image/x-icon" href="#{request.contextPath}/img/favicon.ico" />
        <link rel="stylesheet" type="text/css" href="#{request.contextPath}/css/main.css" />
        <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.71/pdfmake.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.71/vfs_fonts.js"></script>
    </h:head>
    
    <script>
        $.blockUI.defaults.css = {
            padding: 0,
            margin: 0,
            width: '30%',
            top: '40%',
            left: '35%',
            textAlign: 'center',
            color: '#000',
            border: '0px solid #aaa',
            backgroundColor: 'transparent',
            cursor: 'wait'
        };
        $.blockUI.defaults.overlayCSS.backgroundColor = '#b4bab4'; //5E655E b4bab4 eac99a ff0000
        $.blockUI.defaults.overlayCSS.opacity = 0.5;
        $.blockUI.defaults.message = '<b:spinner name="refresh" size="4x" style-class="spiner"/>';
    </script>
    
    <script type="text/javascript">
        // Definir funciones en el ámbito global
        window.validarCampos = function() {
            console.log("VALIDA CAMPOS");
            var campo1 = $('.descripcion_antecedente').val();
            console.log(campo1.value);
            // Verifica si campo1 es undefined o vacío
            if (typeof campo1 === 'undefined' || campo1 === '') {
                alert('Por favor, complete todos los campos requeridos.');
                return false;
            }
        };

        window.handleComplete = function(args) {
            if (args &amp;&amp; !args.validationFailed) {
                closeModal();
            }
        };

        window.closeModal = function() {
            console.log('Closing modal...');
            $('#modalCreacionPersonaAntecedente').modal('hide');
            jsf.ajax.addOnEvent(function(data) { data.validationFailed = true; });
        };
    </script>


    <b:scrollUp distance="200" animation="fade" text="" name="scrollUpCustom" />
    
    <b:modal id="modalCreacionPersonaAntecedente" title="Creación de antecedente" closable="true"
                 close-on-escape="true" backdrop="true" size="modal-lg">
        <b:form id="formAddPersonaAntecedente">
            <b:panel title="Ingrese la información para crear el antecedente del paciente" look="info" collapsible="false" id="panelPersonalAntecedente">
                <b:row>
                    <b:column span="6" >
                        <b:inputText value="#{CitaBean.nombre_antecedente}"
                                     label="Antecedente"
                                     placeholder="Escoja un antecedente"
                                     typeahead="true"
                                     styleClass="nombre_antecedente"
                                     id="nombre_antecedente"
                                     required="true"
                                     typeahead-limit="20"
                                     typeahead-values="#{CitaBean.recuperarNombresAntecedente()}">
                            <f:ajax event="change"
                                    listener="#{CitaBean.recuperarAntecedentesListener()}"
                                    render="nombre_antecedente :growl"/>
                        </b:inputText>
                    </b:column>
                </b:row>
                <b:row>
                    <b:column span="12">
                        <b:inputTextarea value="#{CitaBean.nuevo_persona_antecedente.perAntDescripcion}"
                                     label="Antecedentes Generales"
                                     placeholder="Antecedentes"
                                     styleClass="descripcion_antecedente"
                                     id="descripcion_antecedente"
                                     size="13"
                                     rows="5"
                                     maxlength="2000"
                                     required="true"
                                     requiredMessage="Describa los antecedentes generales"/>
                    </b:column>
                </b:row>
                <b:row>
                    <b:column offset="2" span="4" >
                        <b:commandButton immediate="true"
                 value="Cancelar Antecedente"   
                 onclick="closeModalCancel()"
                 update=":formAddPersonaAntecedente"
                 type="button">
    <b:iconAwesome name="fa-trash"></b:iconAwesome>
</b:commandButton>


                    </b:column>
                    <b:column span="3">
                        <b:commandButton large-screen="full-width" id="submit"
                                        value="Crear Antecedente"
                                        action="#{CitaBean.crearAntecedentePersonal()}"
                                        look="primary"
                                        onclick="return validarCampos();"
                                        onsuccess="handleComplete(args)"
                                        update="commentform:tablaForm :growl"/>
                    </b:column>
                </b:row>
            </b:panel>
        </b:form>
    </b:modal>

    <my:cabecera id="cabecera"/>
    <my:menuLateralMedico id="menuLateralMedico"/>
    <my:menuLateralEstudiante id="menuLateralEstudiante"/>
    <my:menuLateralAdministrador id="menuLateralAdministrador"/>
    <my:menuLateralContador id="menuLateralContador"/>
    

    <h:body>
        
        <p:idleMonitor timeout="600000">
            <p:ajax event="idle" listener="#{LoginBean.sesionInactiva()}" />
        </p:idleMonitor>


        <b:growl id="growl" escape="true" />

        <b:container fluid="true">
            <b:panel span="10" offset="0">
                <b:form id="commentform">
                    <h3 id="reply-title">
                        <b>Cita médica</b>
                    </h3>
                    <!-- ******************************************************************************************************************************************* -->
                    <br/>
                    <b:container id="container" fluid="true" contentDisabled="false">
                        <!-- ******************************************************************************************************************************************* -->
                        <h3>
                            <b>Antecedentes</b>
                        </h3>
                        <br></br>
                        <b:panel title="Antecedente" look="info" collapsible="false">
                            <b:row>
                                <b:column span="12" class="text-center">
                                    <b:commandButton ajax="true"
                                                     value=" Crear Antecedente"
                                                     rendered="#{CitaBean.historia.hisCompletado eq '0'}"
                                                     oncomplete="$('#modalCreacionPersonaAntecedente').modal('show')"
                                                     tooltip="Crear Antecedente" look="primary">
                                        <b:iconAwesome name="stethoscope"></b:iconAwesome>
                                    </b:commandButton>
                                </b:column>
                                
                            </b:row>
                            <br/>
                            <b:row>
                                <b:column span="12">
                                     <h:form id="tablaForm">
                                        <b:dataTable large-screen="full-width" id="inscritosTabla" value="#{CitaBean.lista_persona_antecedente}" var="personaAntecedente" responsive="true" style="font-size: 11px" info="true" content-disabled="false" searching="true"
                                            page-length="7" multi-column-search="true" multi-column-search-position="top" >
                                            <b:dataTableColumn label="Fecha" value="#{CitaBean.fechaFormatoYMDS(personaAntecedente.perAntFechaUlt)}" style="width: 5%" />
                                            <b:dataTableColumn label="Tipo" value="#{CitaBean.antecedenteFormato(personaAntecedente.antecedente.antTipo)}" style="width: 5%" />
                                            <b:dataTableColumn label="Categoría" value="#{personaAntecedente.antecedente.antCategoria}" style="width: 10%" />
                                            <b:dataTableColumn label="Antecedente" value="#{personaAntecedente.antecedente.antGrupo}" style="width: 15%" />
                                            <b:dataTableColumn label="Descripción" value="#{personaAntecedente.perAntDescripcion}" style="width: 50%" />
                                            <b:dataTableColumn label="Doctor" value="#{personaAntecedente.personasByMedPerId.perApellidos} #{personaAntecedente.personasByMedPerId.perNombres}" style="width: 15%" />
                                        </b:dataTable>
                                    </h:form>
                                </b:column>
                            </b:row>
                        </b:panel>
                        
                        <b:row contentDisabled="false">
                        <b:column span="4" offset="4">
                            <b:commandButton large-screen="full-width" id="submit"
                                             value="Actualizar Cita Médica"
                                             action="#{CitaBean.actualizarCita()}"
                                             rendered="#{CitaBean.historia.hisCompletado eq '0'}"
                                             look="primary" ajax="true" update="@form :growl">
                                <f:ajax execute="commentform" render="commentform" />
                            </b:commandButton>
                        </b:column>
                    </b:row>
                    </b:container>
                </b:form>
            </b:panel>
        </b:container>
        <br/><br/><br/><br/>
    </h:body>
    <my:piePagina id="piePagina"/>
</html>